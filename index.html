<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caça ao Tesouro Interativa</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IM+Fell+English+SC&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-image: url('https://www.transparenttextures.com/patterns/old-wall.png');
            background-color: #fdf3e4;
        }
        .font-treasure {
            font-family: 'IM Fell English SC', serif;
        }
        .modal {
            transition: opacity 0.3s ease-in-out;
        }
        #mapContainer iframe {
            width: 100%;
            height: 100%;
            border: 0;
        }
        /* Estilo para o vídeo da câmera */
        #scannerVideo {
            width: 100%;
            max-width: 500px;
            border-radius: 0.5rem;
        }
    </style>
</head>
<body class="bg-yellow-50/50 flex items-center justify-center min-h-screen p-4">

    <!-- Conteúdo Principal -->
    <div class="w-full max-w-2xl text-center bg-white/60 backdrop-blur-sm shadow-2xl rounded-2xl p-8 border-4 border-amber-800/50">
        <header>
            <h1 class="font-treasure text-5xl md:text-6xl text-amber-900 mb-4">Caça ao Tesouro</h1>
            <p class="text-gray-700 text-lg mb-8">Clique na primeira pista para começar. Para as próximas pistas, encontre os envelopes vermelhos e faça a leitura do QR Code. Você começa com 30 minutos de massagem/coçada e, a cada dica aberta, perde 10 minutos. Boa sorte!</p>
        </header>

        <div class="grid grid-cols-2 gap-4">
            <button data-clue="1" class="clue-btn bg-amber-700 hover:bg-amber-800 text-white font-bold py-4 px-6 rounded-lg shadow-lg transform hover:scale-105 transition">Pista 1</button>
            <button data-clue="2" class="clue-btn bg-amber-700 hover:bg-amber-800 text-white font-bold py-4 px-6 rounded-lg shadow-lg transform hover:scale-105 transition">Pista 2 (Ler QR)</button>
            <button data-clue="3" class="clue-btn bg-amber-700 hover:bg-amber-800 text-white font-bold py-4 px-6 rounded-lg shadow-lg transform hover:scale-105 transition">Pista 3 (Ler QR)</button>
            <button data-clue="4" class="clue-btn bg-amber-700 hover:bg-amber-800 text-white font-bold py-4 px-6 rounded-lg shadow-lg transform hover:scale-105 transition">Pista 4 (Ler QR)</button>
        </div>
    </div>

    <!-- Modal para exibir o MAPA -->
    <div id="mapModal" class="modal fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div class="bg-amber-100 rounded-lg shadow-xl p-6 w-full max-w-3xl text-center relative transform scale-95 transition-transform duration-300 flex flex-col">
            <button id="closeMapModal" class="absolute top-3 right-3 text-gray-600 hover:text-gray-900 text-3xl z-10">&times;</button>
            <h2 id="mapModalTitle" class="font-treasure text-3xl text-amber-900 mb-4"></h2>
            <div id="mapContainer" class="border-4 border-amber-800/50 rounded-md overflow-hidden mb-4 w-full aspect-video bg-gray-200"></div>
            <p id="mapModalDescription" class="text-gray-800 text-lg"></p>
            <button id="showHintBtn" class="hidden mt-4 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition self-center">Abrir Dica</button>
        </div>
    </div>

    <!-- Modal para o leitor de QR CODE -->
    <div id="scannerModal" class="modal fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div class="bg-amber-100 rounded-lg shadow-xl p-6 w-full max-w-xl text-center relative transform scale-95 transition-transform duration-300 flex flex-col items-center">
            <button id="closeScannerModal" class="absolute top-3 right-3 text-gray-600 hover:text-gray-900 text-3xl z-10">&times;</button>
            <h2 class="font-treasure text-3xl text-amber-900 mb-4">Ler QR Code</h2>
            <p id="scannerMessage" class="text-gray-700 mb-4">Aponte a câmera para o QR code da pista.</p>
            <video id="scannerVideo" playsinline></video>
            <canvas id="scannerCanvas" class="hidden"></canvas>
        </div>
    </div>

    <!-- Modal para a DICA (IMAGEM) -->
    <div id="hintModal" class="modal fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div class="bg-amber-100 rounded-lg shadow-xl p-6 w-full max-w-2xl text-center relative transform scale-95 transition-transform duration-300">
            <button id="closeHintModal" class="absolute top-3 right-3 text-gray-600 hover:text-gray-900 text-3xl z-10">&times;</button>
            <h2 class="font-treasure text-3xl text-amber-900 mb-4">Dica Visual</h2>
            <img id="hintImage" src="" alt="Dica em imagem para a pista" class="max-w-full max-h-[70vh] mx-auto rounded-md border-4 border-amber-800/50">
        </div>
    </div>
    
    <!-- Biblioteca para ler QR Codes -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <!-- Biblioteca para enviar Emails (EmailJS) -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

    <script>
        // --- CONFIGURAÇÃO DA NOTIFICAÇÃO POR EMAIL (EmailJS) ---
        // IMPORTANTE: Substitua os valores abaixo pelos que você obteve do EmailJS.
        const EMAILJS_SERVICE_ID = 'service_zvfv3dw';
        const EMAILJS_TEMPLATE_ID = 'template_ji63nmq';
        const EMAILJS_PUBLIC_KEY = 'LCe8eu4cdhM707tYD';

        // --- DADOS DAS PISTAS ---
        const clues = {
            '1': {
                title: 'Pista 1: O Início',
                description: 'A jornada começa junto aos aparelhos de ginástica. Talvez o melhor a fazer, quando chegar lá, seja sentar em uma mesinha e procurar pela próxima pista.',
                mapEmbedCode: '<iframe src="https://www.google.com/maps/embed?pb=!1m14!1m12!1m3!1d201.9084963956884!2d-8.56882526414805!3d41.20256462226302!2m3!1f0!2f0!3f0!3m2!1i1024!i768!4f13.1!5e1!3m2!1spt-PT!2spt!4v1759921511343!5m2!1spt-PT!2spt" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>',
                hintImage: 'images/Dica 1.jpeg'
            },
            '2': {
                title: 'Pista 2: As duas arvôres',
                description: 'Voltando para casa, há uma pracinha em formato de triângulo. E nessa pracinha duas arvôres chamam bastante a atenção.',
                mapEmbedCode: null,
                hintImage: 'images/Dica 2.jpeg'
            },
            '3': {
                title: 'Pista 3: Que banquinho Legal',
                description: 'Muito bem. Quando chegar nesse lugar verifique os banquinhos, um deles pode guardar uma ultima pista.',
                mapEmbedCode: null,
                hintImage: 'images/Dica 3.jpeg'
            },
            '4': {
                title: 'Pista Final: Pegue seu presente',
                description: 'Parabéns! Você chegou ao fim. Você tem um jantar marcado para hoje a noite. Agora vai para casa e pegue seu presente dentro do armario da cozinha.',
                mapEmbedCode: null,
                hintImage: null
            }
        };

        // Elementos do DOM
        const clueButtons = document.querySelectorAll('.clue-btn');
        const mapModal = document.getElementById('mapModal');
        const scannerModal = document.getElementById('scannerModal');
        const hintModal = document.getElementById('hintModal');
        const closeMapModalBtn = document.getElementById('closeMapModal');
        const closeScannerModalBtn = document.getElementById('closeScannerModal');
        const closeHintModalBtn = document.getElementById('closeHintModal');
        const video = document.getElementById('scannerVideo');
        const canvasElement = document.getElementById('scannerCanvas');
        const canvas = canvasElement.getContext('2d');
        const scannerMessage = document.getElementById('scannerMessage');
        const showHintBtn = document.getElementById('showHintBtn');
        const hintImage = document.getElementById('hintImage');
        
        let currentScanningClue = null;
        let animationFrameId = null;
        let currentClueData = null;

        // --- FUNÇÕES DO JOGO ---

        function sendEmailNotification(clueTitle) {
            if (EMAILJS_SERVICE_ID === 'SEU_SERVICE_ID' || !EMAILJS_SERVICE_ID) {
                console.log("EmailJS não configurado. Email não enviado.");
                return;
            }
            const templateParams = { pista_titulo: `DICA DA PISTA: ${clueTitle}` };
            emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams, EMAILJS_PUBLIC_KEY)
                .then(function(response) {
                   console.log('Notificação enviada com sucesso!', response.status, response.text);
                }, function(error) {
                   console.error('FALHA ao enviar notificação...', error);
                });
        }

        function showModal(modalElement) {
            modalElement.classList.remove('opacity-0', 'pointer-events-none');
            modalElement.querySelector(':scope > div').classList.remove('scale-95');
        }

        function hideModal(modalElement) {
            modalElement.classList.add('opacity-0');
            modalElement.querySelector(':scope > div').classList.add('scale-95');
            setTimeout(() => modalElement.classList.add('pointer-events-none'), 300);
        }

        function openMapModal(clueData) {
            currentClueData = clueData;
            document.getElementById('mapModalTitle').textContent = clueData.title;
            document.getElementById('mapContainer').innerHTML = clueData.mapEmbedCode;
            document.getElementById('mapModalDescription').textContent = clueData.description;
            
            if (clueData.hintImage) {
                showHintBtn.classList.remove('hidden');
            } else {
                showHintBtn.classList.add('hidden');
            }
            showModal(mapModal);
        }

        function stopScanner() {
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            animationFrameId = null;
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }
            hideModal(scannerModal);
        }

        function tick() {
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                scannerMessage.textContent = "Aponte a câmera para o QR code...";
                canvasElement.height = video.videoHeight;
                canvasElement.width = video.videoWidth;
                canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
                const imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "dontInvert" });

                if (code) {
                    stopScanner();
                    const clueData = clues[currentScanningClue];
                    clueData.mapEmbedCode = code.data;
                    openMapModal(clueData);
                }
            }
            if (video.srcObject) {
                animationFrameId = requestAnimationFrame(tick);
            }
        }

        function startScanner(clueId) {
            currentScanningClue = clueId;
            scannerMessage.textContent = "A pedir permissão para a câmera...";
            showModal(scannerModal);

            navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
                .then(stream => {
                    video.srcObject = stream;
                    video.play();
                    animationFrameId = requestAnimationFrame(tick);
                })
                .catch(err => {
                    console.error("Erro ao aceder à câmera: ", err);
                    scannerMessage.textContent = "Não foi possível aceder à câmera. Verifique as permissões.";
                });
        }
        
        // --- EVENT LISTENERS ---
        clueButtons.forEach(button => {
            button.addEventListener('click', () => {
                const clueId = button.dataset.clue;
                if (clueId === '1') {
                    openMapModal(clues['1']);
                } else {
                    startScanner(clueId);
                }
            });
        });

        showHintBtn.addEventListener('click', () => {
            if (currentClueData && currentClueData.hintImage) {
                hintImage.src = currentClueData.hintImage;
                showModal(hintModal);
                // Envia a notificação por email assim que a DICA é aberta
                sendEmailNotification(currentClueData.title);
            }
        });

        closeMapModalBtn.addEventListener('click', () => hideModal(mapModal));
        closeScannerModalBtn.addEventListener('click', stopScanner);
        closeHintModalBtn.addEventListener('click', () => hideModal(hintModal));
    </script>
</body>
</html>
